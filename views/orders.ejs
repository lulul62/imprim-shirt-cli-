<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImprimShirt</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet"
          type="text/css">
    <link href="https://unpkg.com/vuetify/dist/vuetify.min.css" rel="stylesheet" type="text/css">
    <link href="/stylesheets/style.css" rel="stylesheet" type="text/css">
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
</head>

<body>
<div id="app">
    <v-app>
        <v-navigation-drawer persistent v-model="drawer">
            <v-list>
                <v-list-tile v-for="(item, i) in items" :key="i" v-bind:href="item.link" value="true">
                    <v-list-tile-action>
                        <v-icon light v-html="item.icon"></v-icon>
                    </v-list-tile-action>
                    <v-list-tile-content>
                        <v-list-tile-title v-text="item.title"></v-list-tile-title>
                    </v-list-tile-content>
                </v-list-tile>
            </v-list>
        </v-navigation-drawer>
        <v-toolbar>
            <v-toolbar-side-icon @click.native.stop="drawer = !drawer"></v-toolbar-side-icon>

        </v-toolbar>
        <main>
            <v-container fluid style="    position: relative;
    top: 2em;">
                <v-container fluid>
                    <v-slide-y-transition mode="out-in">
                        <v-layout column align-center>
                            <template>
                                <v-card>
                                    <v-card-title>
                                        Mes commandes
                                        <v-spacer></v-spacer>
                                        <v-text-field
                                                append-icon="search"
                                                label="Rechercher une commande"
                                                single-line
                                                hide-details
                                                v-model="search"
                                        ></v-text-field>
                                    </v-card-title>
                                    <v-data-table
                                            v-bind:headers="headers"
                                            v-bind:items="ordersTable"
                                            v-bind:search="search"
                                    >
                                        <template slot="items" scope="props">
                                            <td>{{ props.item.reference }}</td>
                                            <td class="text-xs-right">{{ props.item.order_date }}</td>
                                            <td class="text-xs-right">{{ props.item.totalPrice }}</td>
                                            <td class="text-xs-right">
                                                <v-btn primary>Voir</v-btn>
                                            </td>
                                            <td class="text-xs-right">{{ props.item.state }}</td>
                                        </template>
                                        <template slot="pageText" scope="{ pageStart, pageStop }">
                                            From {{ pageStart }} to {{ pageStop }}
                                        </template>
                                    </v-data-table>
                                </v-card>
                            </template>
                        </v-layout>
                    </v-slide-y-transition>
                </v-container>
            </v-container>
        </main>
        <v-footer class="pa-3">
            <v-spacer></v-spacer>
            <div>© ImprimShirt {{ new Date().getFullYear() }}</div>
        </v-footer>
    </v-app>
</div>


<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://unpkg.com/vuetify/dist/vuetify.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/1.3.4/vue-resource.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script>
    var isConnected = sessionStorage.getItem("dataKey");
    console.log(isConnected);

    if (isConnected === "" || isConnected === null) {
        window.location.href = "/";
    }

    else {
        Vue.component('page', {
            template: '#page'
        })

        var vm = new Vue({
            el: '#app',
            data: {
                drawer: true,
                fixed: true,
                baseUrlCurrentUser: "https://transfertprod-668c2.firebaseio.com/user/",
                items: [
                    {icon: "note_add", title: "Personnaliser un produit", link: "/product"},
                    {icon: "shopping_cart", title: "Panier", link: "/cart"},
                    {icon: 'account_circle', title: 'Gestion du profil', link: "/gestionProfil"},
                    {icon: 'shopping_basket', title: 'Suivi des commandes', link: '/orders'}
                ],
                tmp: '',
                search: '',
                pagination: {},
                headers: [
                    {
                        text: 'Réference commande',
                        align: 'left',
                        sortable: false,
                        value: 'orderRef'
                    },
                    {text: 'Date de la commande', value: 'date'},
                    {text: 'Prix (euros)', value: 'price'},
                    {text: 'Liste des produits', value: 'product'},
                    {text: 'État de la commande', value: 'state'},
                ],
                ordersTable: [],
                currentUser: {},
                y: 'bottom',
                x: null,
                mode: '',
                right: true,
                title: 'ImprimShirt'
            },
            methods: {
                getCurrentUser: function () {
                    return this.$http.get(this.baseUrlCurrentUser + isConnected + ".json").then((currentUser) => {
                        Object.keys(currentUser.data.orders).forEach((key) => {
                            this.ordersTable.push(currentUser.data.orders[key]);
                        });
                        return this.getTotalPriceOfOrders();
                    });
                },

                getTotalPriceOfOrders: function () {
                    this.ordersTable.forEach(function (order) {
                        let currentPrice = [];
                        order.order_date = moment(order.order_date).format('DD-MMM-YYYY');
                        order.content.forEach(function (product) {
                            currentPrice.push(parseInt(product.price));
                        });
                        order.totalPrice = _.sum(currentPrice);
                    });
                    console.log(this.ordersTable);
                }
            }
        });

        vm.getCurrentUser();

    }
</script>
</body>

</html>